<?xml version="1.0"?>
<project name="mirth-server" basedir="." default="help">

	<property name="keystore_property_file" value="keystore.properties" />
	<property name="manifest_thread_count" value="4" />
	<property name="signjar_thread_count" value="4" />
	<property name="jdk_src_path" value="" />

	<target name="help">
		<echo>Mirth Connect Build Help</echo>
	</target>

	<target name="init">
		<property file="build.properties" />

		<path id="classpath">
			<fileset dir="${lib}" includes="**/*.jar" />
		</path>

		<!-- connectors -->
		<property name="connectors.jms" value="${extensions}/jms" />
		<property name="connectors.jdbc" value="${extensions}/jdbc" />
		<property name="connectors.dicom" value="${extensions}/dicom" />
		<property name="connectors.http" value="${extensions}/http" />
		<property name="connectors.doc" value="${extensions}/doc" />
		<property name="connectors.smtp" value="${extensions}/smtp" />
		<property name="connectors.tcp" value="${extensions}/tcp" />
		<property name="connectors.file" value="${extensions}/file" />
		<property name="connectors.js" value="${extensions}/js" />
		<property name="connectors.ws" value="${extensions}/ws" />
		<property name="connectors.vm" value="${extensions}/vm" />

		<!-- datatypes -->
		<property name="plugins.datatype-delimited" value="${extensions}/datatype-delimited" />
		<property name="plugins.datatype-dicom" value="${extensions}/datatype-dicom" />
		<property name="plugins.datatype-edi" value="${extensions}/datatype-edi" />
		<property name="plugins.datatype-hl7v2" value="${extensions}/datatype-hl7v2" />
		<property name="plugins.datatype-hl7v3" value="${extensions}/datatype-hl7v3" />
		<property name="plugins.datatype-ncpdp" value="${extensions}/datatype-ncpdp" />
		<property name="plugins.datatype-xml" value="${extensions}/datatype-xml" />
		<property name="plugins.datatype-raw" value="${extensions}/datatype-raw" />
		<property name="plugins.datatype-json" value="${extensions}/datatype-json" />
		
		<!-- plugins -->
		<property name="plugins.directoryresource" value="${extensions}/directoryresource" />
		<property name="plugins.dashboardstatus" value="${extensions}/dashboardstatus" />
		<property name="plugins.destinationsetfilter" value="${extensions}/destinationsetfilter" />
		<property name="plugins.dicomviewer" value="${extensions}/dicomviewer" />
		<property name="plugins.httpauth" value="${extensions}/httpauth" />
		<property name="plugins.imageviewer" value="${extensions}/imageviewer" />
		<property name="plugins.javascriptrule" value="${extensions}/javascriptrule" />
		<property name="plugins.javascriptstep" value="${extensions}/javascriptstep" />
		<property name="plugins.mapper" value="${extensions}/mapper" />
		<property name="plugins.messagebuilder" value="${extensions}/messagebuilder" />
		<property name="plugins.datapruner" value="${extensions}/datapruner" />
		<property name="plugins.globalmapviewer" value="${extensions}/globalmapviewer" />
		<property name="plugins.mllpmode" value="${extensions}/mllpmode" />
		<property name="plugins.pdfviewer" value="${extensions}/pdfviewer" />
		<property name="plugins.textviewer" value="${extensions}/textviewer" />
		<property name="plugins.rulebuilder" value="${extensions}/rulebuilder" />
		<property name="plugins.serverlog" value="${extensions}/serverlog" />
		<property name="plugins.scriptfilerule" value="${extensions}/scriptfilerule" />
		<property name="plugins.scriptfilestep" value="${extensions}/scriptfilestep" />
		<property name="plugins.xsltstep" value="${extensions}/xsltstep" />
	</target>

	<target name="clean" depends="init">
		<delete dir="${logs}" />
		<mkdir dir="${logs}" />

		<delete dir="${classes}" />
		<delete dir="${setup}" />
		<delete dir="${dist}" />
		<delete dir="${build}" />
		<delete dir="${docs.javadocs}" />
	</target>

	<target name="compile" depends="clean, init, create-javadocs">
		<!-- compile the source -->
		<mkdir dir="${classes}" />

		<javac srcdir="${src}" destdir="${classes}" debug="on" includeAntRuntime="false">
			<classpath refid="classpath" />
			<!-- Uncomment the following and add additional dashes in front of the arguments to allow Java 9+
				<compilerarg value="-add-modules" />
				<compilerarg value="java.sql.rowset,java.xml.ws" />
				<compilerarg value="-add-exports" />
				<compilerarg value="java.sql.rowset/com.sun.rowset=ALL-UNNAMED" />
			-->
		</javac>

		<!-- create version.properties file -->
		<propertyfile file="version.properties">
			<entry key="mirth.version" value="${version}" />
			<entry key="mirth.date" type="date" value="today" pattern="MMMM d, yyyy" />
		</propertyfile>

		<!-- copy resource files to be placed in jars -->
		<copy todir="${classes}">
			<fileset file="version.properties" />
			<fileset file="mirth-client.jnlp" />
		</copy>
		<copy todir="${classes}/com/mirth/connect/util">
			<fileset dir="${src}/com/mirth/connect/util">
				<include name="*.js" />
			</fileset>
		</copy>
	</target>

	<target name="create-client-core" depends="compile">
		<jar destfile="${setup.server.lib}/${client-core.jar}" basedir="${classes}">
			<include name="com/mirth/connect/client/core/**" />
			<include name="com/mirth/connect/model/**" />
			<include name="com/mirth/connect/userutil/**" />
			<include name="com/mirth/connect/util/**" />
			<include name="com/mirth/connect/server/util/ResourceUtil.class" />
			<include name="org/mozilla/**" />
			<include name="org/glassfish/jersey/**" />
			<include name="de/**" />
			<include name="net/lingala/zip4j/unzip/**" />

			<include name="version.properties" />
		</jar>

		<copy file="${lib}/mirth-crypto.jar" todir="${setup.server.lib}" />
	</target>

	<target name="create-connectors" depends="create-client-core">

		<!-- connectors.dicom -->
		<mkdir dir="${connectors.dicom}" />
		<copy todir="${connectors.dicom}">
			<fileset dir="${src}/com/mirth/connect/connectors/dimse">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.dicom}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/dimse" />
		</copy>
		<jar destfile="${connectors.dicom}/dicom-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/dimse/DICOMReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/dimse/DICOMDispatcherProperties.class" />
		</jar>
		<jar destfile="${connectors.dicom}/dicom-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/dimse/**" />
				<include name="org/dcm4che2/**" />
				<exclude name="com/mirth/connect/connectors/dimse/DICOMReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/dimse/DICOMDispatcherProperties.class" />
			</fileset>
		</jar>

		<!-- connectors.doc -->
		<mkdir dir="${connectors.doc}" />
		<copy todir="${connectors.doc}">
			<fileset dir="${src}/com/mirth/connect/connectors/doc">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.doc}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/doc" />
		</copy>
		<jar destfile="${connectors.doc}/doc-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/doc/DocumentDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/doc/DocumentConnectorServletInterface.class" />
			<include name="com/mirth/connect/connectors/doc/PageSize.class" />
			<include name="com/mirth/connect/connectors/doc/Unit.class" />
		</jar>
		<jar destfile="${connectors.doc}/doc-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/doc/**" />
				<exclude name="com/mirth/connect/connectors/doc/DocumentDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/doc/DocumentConnectorServletInterface.class" />
				<exclude name="com/mirth/connect/connectors/doc/PageSize.class" />
				<exclude name="com/mirth/connect/connectors/doc/Unit.class" />
			</fileset>
		</jar>

		<!-- connectors.file -->
		<mkdir dir="${connectors.file}" />
		<copy todir="${connectors.file}">
			<fileset dir="${src}/com/mirth/connect/connectors/file">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.file}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/file" />
		</copy>
		<jar destfile="${connectors.file}/file-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/file/SchemeProperties.class" />
			<include name="com/mirth/connect/connectors/file/FTPSchemeProperties.class" />
			<include name="com/mirth/connect/connectors/file/SmbDialectVersion.class" />
			<include name="com/mirth/connect/connectors/file/SmbSchemeProperties.class" />
			<include name="com/mirth/connect/connectors/file/SftpSchemeProperties.class" />
			<include name="com/mirth/connect/connectors/file/S3SchemeProperties.class" />
			<include name="com/mirth/connect/connectors/file/FileReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/file/FileDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/file/FileScheme.class" />
			<include name="com/mirth/connect/connectors/file/FileAction.class" />
			<include name="com/mirth/connect/connectors/file/FileConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.file}/file-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/file/**" />
				<include name="jcifs/**" />
				<exclude name="com/mirth/connect/connectors/file/SchemeProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/FTPSchemeProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/SftpSchemeProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/S3SchemeProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/FileReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/FileDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/file/FileScheme.class" />
				<exclude name="com/mirth/connect/connectors/file/FileAction.class" />
				<exclude name="com/mirth/connect/connectors/file/FileConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- connectors.http -->
		<mkdir dir="${connectors.http}" />
		<copy todir="${connectors.http}">
			<fileset dir="${src}/com/mirth/connect/connectors/http">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.http}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/http" />
		</copy>
		<jar destfile="${connectors.http}/http-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/http/HttpReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/http/HttpDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/http/HttpStaticResource.class" />
			<include name="com/mirth/connect/connectors/http/HttpStaticResource$ResourceType.class" />
			<include name="com/mirth/connect/connectors/http/HttpConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.http}/http-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/http/**" />
				<exclude name="com/mirth/connect/connectors/http/HttpReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/http/HttpDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/http/HttpStaticResource.class" />
				<exclude name="com/mirth/connect/connectors/http/HttpStaticResource$ResourceType.class" />
				<exclude name="com/mirth/connect/connectors/http/HttpConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- connectors.jdbc -->
		<mkdir dir="${connectors.jdbc}" />
		<copy todir="${connectors.jdbc}">
			<fileset dir="${src}/com/mirth/connect/connectors/jdbc">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.jdbc}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/jdbc" />
		</copy>
		<jar destfile="${connectors.jdbc}/jdbc-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/jdbc/DatabaseReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/jdbc/DatabaseDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/jdbc/DatabaseConnectionInfo.class" />
			<include name="com/mirth/connect/connectors/jdbc/Table.class" />
			<include name="com/mirth/connect/connectors/jdbc/Column.class" />
			<include name="com/mirth/connect/connectors/jdbc/DatabaseConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.jdbc}/jdbc-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/jdbc/**" />
				<exclude name="com/mirth/connect/connectors/jdbc/DatabaseReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/jdbc/DatabaseDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/jdbc/DatabaseConnectionInfo.class" />
				<exclude name="com/mirth/connect/connectors/jdbc/Table.class" />
				<exclude name="com/mirth/connect/connectors/jdbc/Column.class" />
				<exclude name="com/mirth/connect/connectors/jdbc/DatabaseConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- connectors.jms -->
		<mkdir dir="${connectors.jms}" />
		<copy todir="${connectors.jms}">
			<fileset dir="${src}/com/mirth/connect/connectors/jms">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.jms}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/jms" />
		</copy>
		<jar destfile="${connectors.jms}/jms-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/jms/JmsConnectorProperties.class" />
			<include name="com/mirth/connect/connectors/jms/JmsReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/jms/JmsDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/jms/JmsConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.jms}/jms-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/jms/**" />
				<exclude name="com/mirth/connect/connectors/jms/JmsConnectorProperties.class" />
				<exclude name="com/mirth/connect/connectors/jms/JmsReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/jms/JmsDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/jms/JmsConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- connectors.js -->
		<mkdir dir="${connectors.js}" />
		<copy todir="${connectors.js}">
			<fileset dir="${src}/com/mirth/connect/connectors/js">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.js}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/js" />
		</copy>
		<jar destfile="${connectors.js}/js-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/js/JavaScriptReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/js/JavaScriptDispatcherProperties.class" />
		</jar>
		<jar destfile="${connectors.js}/js-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/js/**" />
				<exclude name="com/mirth/connect/connectors/js/JavaScriptReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/js/JavaScriptDispatcherProperties.class" />
			</fileset>
		</jar>

		<!-- connectors.smtp -->
		<mkdir dir="${connectors.smtp}" />
		<copy todir="${connectors.smtp}">
			<fileset dir="${src}/com/mirth/connect/connectors/smtp">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.smtp}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/smtp" />
		</copy>
		<jar destfile="${connectors.smtp}/smtp-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/smtp/SmtpDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/smtp/SmtpConnectorServletInterface.class" />
			<include name="com/mirth/connect/connectors/smtp/Attachment.class" />
		</jar>
		<jar destfile="${connectors.smtp}/smtp-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/smtp/**" />
				<exclude name="com/mirth/connect/connectors/smtp/SmtpDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/smtp/SmtpConnectorServletInterface.class" />
				<exclude name="com/mirth/connect/connectors/smtp/Attachment.class" />
			</fileset>
		</jar>

		<!-- connectors.tcp -->
		<mkdir dir="${connectors.tcp}" />
		<copy todir="${connectors.tcp}">
			<fileset dir="${src}/com/mirth/connect/connectors/tcp">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.tcp}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/tcp" />
		</copy>
		<jar destfile="${connectors.tcp}/tcp-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/tcp/TcpReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/tcp/TcpDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/tcp/TcpConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.tcp}/tcp-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/tcp/**" />
				<exclude name="com/mirth/connect/connectors/tcp/TcpReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/tcp/TcpDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/tcp/TcpConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- connectors.vm -->
		<mkdir dir="${connectors.vm}" />
		<copy todir="${connectors.vm}">
			<fileset dir="${src}/com/mirth/connect/connectors/vm">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.vm}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/vm" />
		</copy>
		<jar destfile="${connectors.vm}/vm-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/vm/VmReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/vm/VmDispatcherProperties.class" />
		</jar>
		<jar destfile="${connectors.vm}/vm-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/vm/**" />
				<exclude name="com/mirth/connect/connectors/vm/VmReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/vm/VmDispatcherProperties.class" />
			</fileset>
		</jar>

		<!-- connectors.ws -->
		<mkdir dir="${connectors.ws}" />
		<copy todir="${connectors.ws}">
			<fileset dir="${src}/com/mirth/connect/connectors/ws">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${connectors.ws}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/ws" />
		</copy>
		<jar destfile="${connectors.ws}/ws-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/connectors/ws/Binding.class" />
			<include name="com/mirth/connect/connectors/ws/WebServiceReceiverProperties.class" />
			<include name="com/mirth/connect/connectors/ws/WebServiceDispatcherProperties.class" />
			<include name="com/mirth/connect/connectors/ws/DefinitionServiceMap.class" />
			<include name="com/mirth/connect/connectors/ws/DefinitionServiceMap$DefinitionPortMap.class" />
			<include name="com/mirth/connect/connectors/ws/DefinitionServiceMap$PortInformation.class" />
			<include name="com/mirth/connect/connectors/ws/WebServiceConnectorServletInterface.class" />
		</jar>
		<jar destfile="${connectors.ws}/ws-server.jar">
			<fileset dir="${classes}">
				<include name="com/mirth/connect/connectors/ws/**" />
				<exclude name="com/mirth/connect/connectors/ws/Binding.class" />
				<exclude name="com/mirth/connect/connectors/ws/WebServiceReceiverProperties.class" />
				<exclude name="com/mirth/connect/connectors/ws/WebServiceDispatcherProperties.class" />
				<exclude name="com/mirth/connect/connectors/ws/DefinitionServiceMap.class" />
				<exclude name="com/mirth/connect/connectors/ws/DefinitionServiceMap$DefinitionPortMap.class" />
				<exclude name="com/mirth/connect/connectors/ws/DefinitionServiceMap$PortInformation.class" />
				<exclude name="com/mirth/connect/connectors/ws/WebServiceConnectorServletInterface.class" />
			</fileset>
		</jar>

		<!-- set the version on all connectors -->
		<replace dir="${extensions}" token="@mirthversion" value="${version}">
			<include name="**/*.xml" />
		</replace>
	</target>

	<target name="create-plugins" depends="create-connectors">
		<!-- plugins.datatype-delimited -->
		<mkdir dir="${plugins.datatype-delimited}" />
		<copy todir="${plugins.datatype-delimited}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/delimited">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-delimited}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/delimited" />
		</copy>
		<jar destfile="${plugins.datatype-delimited}/datatype-delimited-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/delimited/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/delimited/DelimitedDataTypeServerPlugin.class" />
			<exclude name="com/mirth/connect/plugins/datatypes/delimited/DelimitedBatchAdaptor.class" />
			<exclude name="com/mirth/connect/plugins/datatypes/delimited/DelimitedBatchReader.class" />
		</jar>
		<jar destfile="${plugins.datatype-delimited}/datatype-delimited-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/delimited/DelimitedDataTypeServerPlugin.class" />
			<include name="com/mirth/connect/plugins/datatypes/delimited/DelimitedBatchAdaptor.class" />
			<include name="com/mirth/connect/plugins/datatypes/delimited/DelimitedBatchReader.class" />
		</jar>
		
		<!-- plugins.datatype-dicom -->
		<mkdir dir="${plugins.datatype-dicom}" />
		<copy todir="${plugins.datatype-dicom}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/dicom">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-dicom}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/dicom" />
		</copy>
		<jar destfile="${plugins.datatype-dicom}/datatype-dicom-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/dicom/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/dicom/DICOMDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-dicom}/datatype-dicom-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/dicom/DICOMDataTypeServerPlugin.class" />
		</jar>
		
		
		<!-- plugins.datatype-edi -->
		<mkdir dir="${plugins.datatype-edi}" />
		<copy todir="${plugins.datatype-edi}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/edi">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-edi}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/edi" />
		</copy>
		<!-- copy the xml files so they will be included in jar -->
		<copy todir="${classes}/com/mirth/connect/plugins/datatypes/edi/xml">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/edi/xml" />
		</copy>
		<jar destfile="${plugins.datatype-edi}/datatype-edi-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/edi/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/edi/EDIDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-edi}/datatype-edi-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/edi/EDIDataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.datatype-hl7v2 -->
		<mkdir dir="${plugins.datatype-hl7v2}" />
		<copy todir="${plugins.datatype-hl7v2}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/hl7v2">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-hl7v2}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/hl7v2" />
		</copy>
		<jar destfile="${plugins.datatype-hl7v2}/datatype-hl7v2-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/hl7v2/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/hl7v2/HL7v2DataTypeServerPlugin.class" />
			<exclude name="com/mirth/connect/plugins/datatypes/hl7v2/HL7v2BatchAdaptor.class" />
		</jar>
		<jar destfile="${plugins.datatype-hl7v2}/datatype-hl7v2-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/hl7v2/HL7v2DataTypeServerPlugin.class" />
			<include name="com/mirth/connect/plugins/datatypes/hl7v2/HL7v2BatchAdaptor.class" />
		</jar>
		
		<!-- plugins.datatype-hl7v3 -->
		<mkdir dir="${plugins.datatype-hl7v3}" />
		<copy todir="${plugins.datatype-hl7v3}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/hl7v3">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-hl7v3}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/hl7v3" />
		</copy>
		<jar destfile="${plugins.datatype-hl7v3}/datatype-hl7v3-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/hl7v3/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/hl7v3/HL7V3DataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-hl7v3}/datatype-hl7v3-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/hl7v3/HL7V3DataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.datatype-ncpdp -->
		<mkdir dir="${plugins.datatype-ncpdp}" />
		<copy todir="${plugins.datatype-ncpdp}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/ncpdp">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-ncpdp}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/ncpdp" />
		</copy>
		<jar destfile="${plugins.datatype-ncpdp}/datatype-ncpdp-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/ncpdp/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/ncpdp/NCPDPDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-ncpdp}/datatype-ncpdp-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/ncpdp/NCPDPDataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.datatype-xml -->
		<mkdir dir="${plugins.datatype-xml}" />
		<copy todir="${plugins.datatype-xml}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/xml">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-xml}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/xml" />
		</copy>
		<jar destfile="${plugins.datatype-xml}/datatype-xml-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/xml/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/xml/XMLDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-xml}/datatype-xml-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/xml/XMLDataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.datatype-raw -->
		<mkdir dir="${plugins.datatype-raw}" />
		<copy todir="${plugins.datatype-raw}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/raw">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-raw}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/raw" />
		</copy>
		<jar destfile="${plugins.datatype-raw}/datatype-raw-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/raw/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/raw/RawDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-raw}/datatype-raw-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/raw/RawDataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.datatype-json -->
		<mkdir dir="${plugins.datatype-json}" />
		<copy todir="${plugins.datatype-json}">
			<fileset dir="${src}/com/mirth/connect/plugins/datatypes/json">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datatype-json}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datatypes/json" />
		</copy>
		<jar destfile="${plugins.datatype-json}/datatype-json-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/json/**" />
			<exclude name="com/mirth/connect/plugins/datatypes/json/JSONDataTypeServerPlugin.class" />
		</jar>
		<jar destfile="${plugins.datatype-json}/datatype-json-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datatypes/json/JSONDataTypeServerPlugin.class" />
		</jar>
		
		<!-- plugins.directoryresource -->
		<mkdir dir="${plugins.directoryresource}" />
		<copy todir="${plugins.directoryresource}">
			<fileset dir="${src}/com/mirth/connect/plugins/directoryresource">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.directoryresource}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/directoryresource" />
		</copy>
		<jar destfile="${plugins.directoryresource}/directoryresource-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/directoryresource/DirectoryResourceProperties.class" />
			<include name="com/mirth/connect/plugins/directoryresource/DirectoryResourceServletInterface.class" />
		</jar>
		<jar destfile="${plugins.directoryresource}/directoryresource-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/directoryresource/**" />
			<exclude name="com/mirth/connect/plugins/directoryresource/DirectoryResourceProperties.class" />
			<exclude name="com/mirth/connect/plugins/directoryresource/DirectoryResourceServletInterface.class" />
		</jar>
		
		<!-- plugins.dashboardstatus -->
		<mkdir dir="${plugins.dashboardstatus}" />
		<copy todir="${plugins.dashboardstatus}">
			<fileset dir="${src}/com/mirth/connect/plugins/dashboardstatus">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.dashboardstatus}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/dashboardstatus" />
		</copy>
		<jar destfile="${plugins.dashboardstatus}/dashboardstatus-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/dashboardstatus/ConnectionLogItem.class" />
			<include name="com/mirth/connect/plugins/dashboardstatus/DashboardConnectorStatusServletInterface.class" />
		</jar>
		<jar destfile="${plugins.dashboardstatus}/dashboardstatus-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/dashboardstatus/**" />
			<exclude name="com/mirth/connect/plugins/dashboardstatus/ConnectionLogItem.class" />
			<exclude name="com/mirth/connect/plugins/dashboardstatus/DashboardConnectorStatusServletInterface.class" />
		</jar>
		
		<!-- plugins.destinationsetfilter -->
		<mkdir dir="${plugins.destinationsetfilter}" />
		<copy todir="${plugins.destinationsetfilter}">
			<fileset dir="${src}/com/mirth/connect/plugins/destinationsetfilter">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.destinationsetfilter}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/destinationsetfilter" />
		</copy>
		<jar destfile="${plugins.destinationsetfilter}/destinationsetfilter-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/destinationsetfilter/DestinationSetFilterStep.class" />
			<include name="com/mirth/connect/plugins/destinationsetfilter/DestinationSetFilterStep$Behavior.class" />
			<include name="com/mirth/connect/plugins/destinationsetfilter/DestinationSetFilterStep$Condition.class" />
		</jar>

		<!-- plugins.dicomviewer -->
		<mkdir dir="${plugins.dicomviewer}" />
		<copy todir="${plugins.dicomviewer}">
			<fileset dir="${src}/com/mirth/connect/plugins/dicomviewer">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.dicomviewer}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/dicomviewer" />
		</copy>
		
		<!-- plugins.globalmapviewer -->
		<mkdir dir="${plugins.globalmapviewer}" />
		<copy todir="${plugins.globalmapviewer}">
			<fileset dir="${src}/com/mirth/connect/plugins/globalmapviewer">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.globalmapviewer}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/globalmapviewer" />
		</copy>
		<jar destfile="${plugins.globalmapviewer}/globalmapviewer-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/globalmapviewer/GlobalMapServletInterface.class" />
		</jar>
		<jar destfile="${plugins.globalmapviewer}/globalmapviewer-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/globalmapviewer/**" />
			<exclude name="com/mirth/connect/plugins/globalmapviewer/GlobalMapServletInterface.class" />
		</jar>
		
		<!-- plugins.httpauth -->
		<mkdir dir="${plugins.httpauth}" />
		<copy todir="${plugins.httpauth}">
			<fileset dir="${src}/com/mirth/connect/plugins/httpauth">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.httpauth}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/httpauth" />
		</copy>
		<jar destfile="${plugins.httpauth}/httpauth-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/httpauth/HttpAuthConnectorPluginProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/HttpAuthConnectorPluginProperties$AuthType.class" />
			<include name="com/mirth/connect/plugins/httpauth/NoneHttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/basic/BasicHttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties$Algorithm.class" />
			<include name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties$QOPMode.class" />				
			<include name="com/mirth/connect/plugins/httpauth/custom/CustomHttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/javascript/JavaScriptHttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/oauth2/OAuth2HttpAuthProperties.class" />
			<include name="com/mirth/connect/plugins/httpauth/oauth2/OAuth2HttpAuthProperties$TokenLocation.class" />
		</jar>
		<jar destfile="${plugins.httpauth}/httpauth-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/httpauth/**" />
			<exclude name="com/mirth/connect/plugins/httpauth/HttpAuthConnectorPluginProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/HttpAuthConnectorPluginProperties$AuthType.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/NoneHttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/basic/BasicHttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties$Algorithm.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/digest/DigestHttpAuthProperties$QOPMode.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/custom/CustomHttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/javascript/JavaScriptHttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/oauth2/OAuth2HttpAuthProperties.class" />
			<exclude name="com/mirth/connect/plugins/httpauth/oauth2/OAuth2HttpAuthProperties$TokenLocation.class" />
		</jar>
		<jar destfile="${plugins.httpauth}/src/httpauth-userutil-sources.jar" basedir="${src}">
			<include name="com/mirth/connect/plugins/httpauth/userutil/**" />
		</jar>

		<!-- plugins.imageviewer -->
		<mkdir dir="${plugins.imageviewer}" />
		<copy todir="${plugins.imageviewer}">
			<fileset dir="${src}/com/mirth/connect/plugins/imageviewer">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.imageviewer}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/imageviewer" />
		</copy>

		<!-- plugins.javascriptrule -->
		<mkdir dir="${plugins.javascriptrule}" />
		<copy todir="${plugins.javascriptrule}">
			<fileset dir="${src}/com/mirth/connect/plugins/javascriptrule">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.javascriptrule}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/javascriptrule" />
		</copy>
		<jar destfile="${plugins.javascriptrule}/javascriptrule-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/javascriptrule/JavaScriptRule.class" />
		</jar>

		<!-- plugins.javascriptstep -->
		<mkdir dir="${plugins.javascriptstep}" />
		<copy todir="${plugins.javascriptstep}">
			<fileset dir="${src}/com/mirth/connect/plugins/javascriptstep">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.javascriptstep}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/javascriptstep" />
		</copy>
		<jar destfile="${plugins.javascriptstep}/javascriptstep-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/javascriptstep/JavaScriptStep.class" />
		</jar>

		<!-- plugins.mapper -->
		<mkdir dir="${plugins.mapper}" />
		<copy todir="${plugins.mapper}">
			<fileset dir="${src}/com/mirth/connect/plugins/mapper">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.mapper}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/mapper" />
		</copy>
		<jar destfile="${plugins.mapper}/mapper-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/mapper/MapperStep.class" />
			<include name="com/mirth/connect/plugins/mapper/MapperStep$Scope.class" />
		</jar>

		<!-- plugins.messagebuilder -->
		<mkdir dir="${plugins.messagebuilder}" />
		<copy todir="${plugins.messagebuilder}">
			<fileset dir="${src}/com/mirth/connect/plugins/messagebuilder">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.messagebuilder}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/messagebuilder" />
		</copy>
		<jar destfile="${plugins.messagebuilder}/messagebuilder-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/messagebuilder/MessageBuilderStep.class" />
		</jar>

		<!-- plugins.datapruner -->
		<mkdir dir="${plugins.datapruner}" />
		<copy todir="${plugins.datapruner}">
			<fileset dir="${src}/com/mirth/connect/plugins/datapruner">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.datapruner}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/datapruner" />
		</copy>
		<jar destfile="${plugins.datapruner}/datapruner-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datapruner/DataPrunerServletInterface.class" />
		</jar>
		<jar destfile="${plugins.datapruner}/datapruner-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/datapruner/**" />
			<exclude name="com/mirth/connect/plugins/datapruner/DataPrunerServletInterface.class" />
		</jar>

		<!-- plugins.mllpmode -->
		<mkdir dir="${plugins.mllpmode}" />
		<copy todir="${plugins.mllpmode}">
			<fileset dir="${src}/com/mirth/connect/plugins/mllpmode">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.mllpmode}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/mllpmode" />
		</copy>
		<jar destfile="${plugins.mllpmode}/mllpmode-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/mllpmode/MLLPModeProperties.class" />
		</jar>
		<jar destfile="${plugins.mllpmode}/mllpmode-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/mllpmode/**" />
			<exclude name="com/mirth/connect/plugins/mllpmode/MLLPModeProperties.class" />
		</jar>

		<!-- plugins.pdfviewer -->
		<mkdir dir="${plugins.pdfviewer}" />
		<copy todir="${plugins.pdfviewer}">
			<fileset dir="${src}/com/mirth/connect/plugins/pdfviewer">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.pdfviewer}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/pdfviewer" />
		</copy>

		<!-- plugins.textviewer -->
		<mkdir dir="${plugins.textviewer}" />
		<copy todir="${plugins.textviewer}">
			<fileset dir="${src}/com/mirth/connect/plugins/textviewer">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.textviewer}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/textviewer" />
		</copy>

		<!-- plugins.rulebuilder -->
		<mkdir dir="${plugins.rulebuilder}" />
		<copy todir="${plugins.rulebuilder}">
			<fileset dir="${src}/com/mirth/connect/plugins/rulebuilder">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.rulebuilder}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/rulebuilder" />
		</copy>
		<jar destfile="${plugins.rulebuilder}/rulebuilder-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/rulebuilder/RuleBuilderRule.class" />
			<include name="com/mirth/connect/plugins/rulebuilder/RuleBuilderRule$Condition.class" />
		</jar>

		<!-- plugins.serverlog -->
		<mkdir dir="${plugins.serverlog}" />
		<copy todir="${plugins.serverlog}">
			<fileset dir="${src}/com/mirth/connect/plugins/serverlog">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.serverlog}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/serverlog" />
		</copy>
		<jar destfile="${plugins.serverlog}/serverlog-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/serverlog/ServerLogItem.class" />
			<include name="com/mirth/connect/plugins/serverlog/ServerLogServletInterface.class" />
		</jar>
		<jar destfile="${plugins.serverlog}/serverlog-server.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/serverlog/**" />
			<exclude name="com/mirth/connect/plugins/serverlog/ServerLogItem.class" />
			<exclude name="com/mirth/connect/plugins/serverlog/ServerLogServletInterface.class" />
		</jar>

		<!-- plugins.scriptfilerule -->
		<mkdir dir="${plugins.scriptfilerule}" />
		<copy todir="${plugins.scriptfilerule}">
			<fileset dir="${src}/com/mirth/connect/plugins/scriptfilerule">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.scriptfilerule}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/scriptfilerule" />
		</copy>
		<jar destfile="${plugins.scriptfilerule}/scriptfilerule-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/scriptfilerule/ExternalScriptRule.class" />
		</jar>

		<!-- plugins.scriptfilestep -->
		<mkdir dir="${plugins.scriptfilestep}" />
		<copy todir="${plugins.scriptfilestep}">
			<fileset dir="${src}/com/mirth/connect/plugins/scriptfilestep">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.scriptfilestep}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/scriptfilestep" />
		</copy>
		<jar destfile="${plugins.scriptfilestep}/scriptfilestep-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/scriptfilestep/ExternalScriptStep.class" />
		</jar>

		<!-- plugins.xsltstep -->
		<mkdir dir="${plugins.xsltstep}" />
		<copy todir="${plugins.xsltstep}">
			<fileset dir="${src}/com/mirth/connect/plugins/xsltstep">
				<include name="*.xml" />
			</fileset>
		</copy>
		<copy todir="${plugins.xsltstep}/lib" failonerror="false">
			<fileset dir="${lib.extensions}/xsltstep" />
		</copy>
		<jar destfile="${plugins.xsltstep}/xsltstep-shared.jar" basedir="${classes}">
			<include name="com/mirth/connect/plugins/xsltstep/XsltStep.class" />
		</jar>

		<!-- set the version on all plugins -->
		<replace dir="${extensions}" token="@mirthversion" value="${version}">
			<include name="**/*.xml" />
		</replace>
	</target>

	<target name="create-setup" depends="init">
		<echo>Sub-project files have been copied into setup</echo>

		<!-- create the setup directory -->
		<mkdir dir="${setup}" />
		<mkdir dir="${setup.conf}" />
		<mkdir dir="${setup.extensions}" />
		<mkdir dir="${setup.public_html}" />
		<mkdir dir="${setup.public_api_html}" />
		<mkdir dir="${setup.server.lib}" />
		<mkdir dir="${setup.client.lib}" />
		<mkdir dir="${setup.manager.lib}" />
		<mkdir dir="${setup.cli.lib}" />
		<mkdir dir="${setup.logs}" />
		<mkdir dir="${setup.docs}" />
		<mkdir dir="${setup.server.launcher.lib}" />

		<!-- copy lib -->
		<copy todir="${setup.server.lib}">
			<fileset dir="${lib}">
				<exclude name="ant/**" />
				<exclude name="extensions/**" />
			</fileset>
		</copy>

		<!-- copy conf files -->
		<copy todir="${setup.conf}">
			<fileset dir="${conf}" />
		</copy>

		<!-- copy public html files -->
		<copy todir="${setup.public_html}">
			<fileset dir="${public_html}">
				<exclude name="Thumbs.db" />
			</fileset>
		</copy>
		
		<replace dir="${setup.public_html}" token="@mirthversion" value="${version}">
			<include name="*.html" />
		</replace>
		
		<!-- copy Swagger UI files -->
		<copy todir="${setup.public_api_html}">
			<fileset dir="${public_api_html}">
				<exclude name="Thumbs.db" />
			</fileset>
		</copy>

		<!-- copy extensions files -->
		<copy todir="${setup.extensions}">
			<fileset dir="${extensions}" />
		</copy>

		<!-- copy docs files -->
		<copy todir="${setup.docs}">
			<fileset dir="${docs}" />
		</copy>

		<!-- create the server jar -->
		<jar destfile="${setup.server.lib}/${server.jar}" basedir="${classes}">
			<include name="com/mirth/connect/server/**" />
			<include name="com/mirth/connect/model/**" />
			<include name="com/mirth/connect/util/**" />
			<include name="com/mirth/connect/plugins/*.class" />
			<include name="com/mirth/connect/connectors/*.class" />
			<include name="org/**" />
			<include name="net/sourceforge/jtds/ssl/**" />

			<include name="mirth-client.jnlp" />

			<exclude name="com/mirth/connect/server/launcher/**" />
			<exclude name="org/dcm4che2/**" />
		</jar>

		<!-- create the dbconf jar -->
		<jar destfile="${setup.server.lib}/${dbconf.jar}" basedir="${dbconf}" />

		<!-- create the mirth-launcher jar -->
		<jar destfile="${setup}/${mirth-launcher.jar}" basedir="${classes}">
			<include name="com/mirth/connect/server/launcher/**" />
			<include name="com/mirth/connect/server/extprops/**" />

			<manifest>
				<attribute name="Main-Class" value="com.mirth.connect.server.launcher.MirthLauncher" />
				<attribute name="Class-Path" value="server-lib/commons/commons-io-2.6.jar server-lib/commons/commons-configuration2-2.7.jar server-lib/commons/commons-lang3-3.9.jar server-lib/commons/commons-logging-1.2.jar server-lib/commons/commons-beanutils-1.9.3.jar server-lib/commons/commons-collections-3.2.2.jar server-lib/commons/commons-text-1.8.jar conf/" />
			</manifest>
		</jar>
		
		<!-- create the userutil-sources jar -->
		<jar destfile="${setup.client.lib}/${userutil-sources.jar}" basedir="${src}">
			<include name="com/mirth/connect/userutil/**.java" />
			<include name="com/mirth/connect/server/userutil/**.java" />
			<exclude name="**/package-info.java" />
		</jar>

		<!-- remove svn folders -->
		<delete>
			<fileset dir="${setup}" includes="**/.svn" />
		</delete>
		
		<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="classpath" />

		<!-- modify jar manifests -->
		<!-- don't modify bcprov, since it already has the manifest changes and is signed by BC -->
		<echo message="[Thread Count: ${manifest_thread_count}] Modifying jar manifests to add Permissions: all-permissions; Codebase: *; Application-Name: Mirth Connect" />
		<for param="jarFile" parallel="true" threadCount="${manifest_thread_count}">
	    	<fileset dir="${setup.client.lib}" includes="**/*.jar" excludes="bcp*.jar"/>
	    	<fileset dir="${setup.extensions}" includes="**/*.jar" />
			<sequential>
				<apply executable="jar">
			        <arg value="umf" />
			        <arg line="custom_manifest.mf" />
			        <srcfile />
			    	<fileset file="@{jarFile}"/>
			    </apply>
			</sequential>
		</for>

		<!-- sign jars for webstart -->
		<echo message="[Thread Count: ${signjar_thread_count}] Signing jars for Java Web Start" />
		<property file="${keystore_property_file}" />
		
		<for param="jarFile" parallel="true" threadCount="${signjar_thread_count}">
			<fileset dir="${setup.client.lib}" includes="**/*.jar" />
			<fileset dir="${setup.extensions}" includes="**/*.jar" />
			<sequential>
				<retry retrycount="5" retrydelay="1000">
					<signjar jar="@{jarFile}" alias="${key.alias}" keystore="${key.keystore}" storepass="${key.storepass}" keypass="${key.keypass}" storetype="${key.storetype}" tsaurl="http://sha256timestamp.ws.symantec.com/sha256/timestamp" digestalg="SHA-256">
						<!-- http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7127374 -->
						<sysproperty key="jsse.enableSNIExtension" value="false" />
						<sysproperty key="https.protocols" value="TLSv1.2,TLSv1.1" />
					</signjar>
				</retry>
			</sequential>
		</for>
	</target>

	<target name="create-extension-zips" depends="create-setup">
		<delete dir="${dist.extensions}" />
		<mkdir dir="${dist.extensions}" />

		<zip destfile="${dist.extensions}/jms-${version}.zip" basedir="${extensions}" includes="jms/**/*" />
		<zip destfile="${dist.extensions}/jdbc-${version}.zip" basedir="${extensions}" includes="jdbc/**/*" />
		<zip destfile="${dist.extensions}/dicom-${version}.zip" basedir="${extensions}" includes="dicom/**/*" />
		<zip destfile="${dist.extensions}/http-${version}.zip" basedir="${extensions}" includes="http/**/*" />
		<zip destfile="${dist.extensions}/doc-${version}.zip" basedir="${extensions}" includes="doc/**/*" />
		<zip destfile="${dist.extensions}/smtp-${version}.zip" basedir="${extensions}" includes="smtp/**/*" />
		<zip destfile="${dist.extensions}/tcp-${version}.zip" basedir="${extensions}" includes="tcp/**/*" />
		<zip destfile="${dist.extensions}/file-${version}.zip" basedir="${extensions}" includes="file/**/*" />
		<zip destfile="${dist.extensions}/js-${version}.zip" basedir="${extensions}" includes="js/**/*" />
		<zip destfile="${dist.extensions}/ws-${version}.zip" basedir="${extensions}" includes="ws/**/*" />
		<zip destfile="${dist.extensions}/vm-${version}.zip" basedir="${extensions}" includes="vm/**/*" />
		
		<zip destfile="${dist.extensions}/datatype-delimited-${version}.zip" basedir="${extensions}" includes="datatype-delimited/**/*" />
		<zip destfile="${dist.extensions}/datatype-dicom-${version}.zip" basedir="${extensions}" includes="datatype-dicom/**/*" />
		<zip destfile="${dist.extensions}/datatype-edi-${version}.zip" basedir="${extensions}" includes="datatype-edi/**/*" />
		<zip destfile="${dist.extensions}/datatype-hl7v2-${version}.zip" basedir="${extensions}" includes="datatype-hl7v2/**/*" />
		<zip destfile="${dist.extensions}/datatype-hl7v3-${version}.zip" basedir="${extensions}" includes="datatype-hl7v3/**/*" />
		<zip destfile="${dist.extensions}/datatype-ncpdp-${version}.zip" basedir="${extensions}" includes="datatype-ncpdp/**/*" />
		<zip destfile="${dist.extensions}/datatype-xml-${version}.zip" basedir="${extensions}" includes="datatype-xml/**/*" />
		<zip destfile="${dist.extensions}/datatype-raw-${version}.zip" basedir="${extensions}" includes="datatype-raw/**/*" />
		<zip destfile="${dist.extensions}/datatype-json-${version}.zip" basedir="${extensions}" includes="datatype-json/**/*" />

		<zip destfile="${dist.extensions}/directoryresource-${version}.zip" basedir="${extensions}" includes="directoryresource/**/*" />
		<zip destfile="${dist.extensions}/dashboardstatus-${version}.zip" basedir="${extensions}" includes="dashboardstatus/**/*" />
		<zip destfile="${dist.extensions}/destinationsetfilter-${version}.zip" basedir="${extensions}" includes="destinationsetfilter/**/*" />
		<zip destfile="${dist.extensions}/serverlog-${version}.zip" basedir="${extensions}" includes="serverlog/**/*" />
		<zip destfile="${dist.extensions}/datapruner-${version}.zip" basedir="${extensions}" includes="datapruner/**/*" />
		<zip destfile="${dist.extensions}/javascriptstep-${version}.zip" basedir="${extensions}" includes="javascriptstep/**/*" />
		<zip destfile="${dist.extensions}/mapper-${version}.zip" basedir="${extensions}" includes="mapper/**/*" />
		<zip destfile="${dist.extensions}/messagebuilder-${version}.zip" basedir="${extensions}" includes="messagebuilder/**/*" />
		<zip destfile="${dist.extensions}/scriptfilestep-${version}.zip" basedir="${extensions}" includes="scriptfilestep/**/*" />
		<zip destfile="${dist.extensions}/rulebuilder-${version}.zip" basedir="${extensions}" includes="rulebuilder/**/*" />
		<zip destfile="${dist.extensions}/javascriptrule-${version}.zip" basedir="${extensions}" includes="javascriptrule/**/*" />
		<zip destfile="${dist.extensions}/dicomviewer-${version}.zip" basedir="${extensions}" includes="dicomviewer/**/*" />
		<zip destfile="${dist.extensions}/pdfviewer-${version}.zip" basedir="${extensions}" includes="pdfviewer/**/*" />
		<zip destfile="${dist.extensions}/textviewer-${version}.zip" basedir="${extensions}" includes="textviewer/**/*" />
		<zip destfile="${dist.extensions}/httpauth-${version}.zip" basedir="${extensions}" includes="httpauth/**/*" />
		<zip destfile="${dist.extensions}/imageviewer-${version}.zip" basedir="${extensions}" includes="imageviewer/**/*" />
		<zip destfile="${dist.extensions}/globalmapviewer-${version}.zip" basedir="${extensions}" includes="globalmapviewer/**/*" />
	</target>

	<target name="create-dist" depends="create-extension-zips">
		<mkdir dir="${dist}" />
	</target>
	
	<target name="create-javadocs" depends="init">
		<mkdir dir="${docs.javadocs}" />
		
		<javadoc sourcepath="${src}:${jdk_src_path}" destdir="${docs.javadocs.userapi}" packagenames="com.mirth.connect.server.userutil,com.mirth.connect.userutil,com.mirth.connect.plugins.httpauth.userutil" link="https://docs.oracle.com/javase/8/docs/api/">
			<classpath refid="classpath" />
			<!-- Uncomment the following and add additional dashes in front of the arguments to allow Java 9+
				<arg line="-html5"/>
				<arg line="-add-modules java.sql.rowset"/>
				<arg line="-add-exports java.sql.rowset/com.sun.rowset=ALL-UNNAMED"/>
			-->
		</javadoc>
	</target>

	<target name="create-derby-db" depends="compile">
		<!-- re-create the embedded database -->
		<delete dir="mirthdb" />
		<java classname="com.mirth.connect.server.tools.ScriptRunner" fork="true" dir="${basedir}" failonerror="true">
			<classpath>
				<pathelement location="${setup.server.lib}/${server.jar}" />
				<pathelement location="classes" />
				<pathelement location="${setup.conf}" />
				<fileset dir="${lib}">
					<include name="log4j-1.2.16.jar" />
					<include name="database/derby-10.10.2.0.jar" />
					<include name="database/derbytools-10.10.2.0.jar" />
					<include name="commons/commons-io-2.3.jar" />
				</fileset>
			</classpath>
			<arg value="dbconf/derby/derby-database.sql" />
		</java>
	</target>

	<target name="dev-launcher" depends="init" description="This runs Mirth using the setup launcher">
		<java classname="com.mirth.connect.server.launcher.MirthLauncher" fork="true" dir="${setup}" failonerror="true">
			<classpath>
				<pathelement location="${setup}/mirth-launcher.jar" />
			</classpath>
		</java>
	</target>

	<target name="dev-run" depends="init" description="This runs the mirth server using the Eclipse environment">
		<java classname="com.mirth.connect.server.Mirth" fork="true" dir="${basedir}" failonerror="true">
			<classpath>
				<pathelement location="bin" />
				<pathelement location="conf" />
				<pathelement location="build" />
				<fileset dir="${lib}">
					<include name="**/*.jar" />
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>
	
	<target name="test-init" depends="init">
		<delete dir="${test_classes}" />
		
		<path id="testclasspath">
			<fileset dir="testlib" includes="**/*.jar" />
			<dirset dir="${classes}"/>
			<path refid="classpath" />
		</path>
	</target>
	
	<target name="test-compile" depends="test-init">
		<!-- compile the source -->
		<mkdir dir="${test_classes}" />
		
		<javac srcdir="${test}" destdir="${test_classes}" debug="on" includeAntRuntime="false">
			<classpath refid="testclasspath" />
			<!-- Uncomment the following and add additional dashes in front of the arguments to allow Java 9+
				<compilerarg value="-add-modules" />
				<compilerarg value="java.sql.rowset,java.xml.ws" />
				<compilerarg value="-add-exports" />
				<compilerarg value="java.sql.rowset/com.sun.rowset=ALL-UNNAMED" />
			-->
		</javac>
		
		<copy todir="${test_classes}">
			<fileset dir="${test}">
				<include name="**/*.xml" />
			</fileset>
		</copy>
		
		<jar destfile="${test.dist}/${tests.jar}" basedir="${test_classes}">
			<include name="**/*" />
		</jar>
	</target>
	
	<taskdef uri="antlib:org.jacoco.ant" resource="org/jacoco/ant/antlib.xml">
		<classpath path="lib/ant/jacocoant.jar"/>
	</taskdef>
	
	<target name="test-run" depends="test-compile">
		<property name="junit-reports" value="junit-reports" />
		<property name="code-coverage-reports" value="code-coverage-reports" />
		<mkdir dir="${junit-reports}" />
		<mkdir dir="${code-coverage-reports}" />
		
		<jacoco:coverage destfile="${code-coverage-reports}/jacoco.exec" xmlns:jacoco="antlib:org.jacoco.ant" exclclassloader="sun.reflect.DelegatingClassLoader:javassist.Loader" >
			<junit haltonfailure="false" fork="true" forkmode="once">
				<jvmarg value="-Xms128m" />
				<jvmarg value="-Xmx1024m" />
				<!-- Uncomment the following and add additional dashes in front of the arguments to allow Java 9+
					<jvmarg value="-add-opens=java.base/java.util=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.base/java.lang=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.base/java.lang.reflect=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.base/java.text=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.desktop/java.awt=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.desktop/java.awt.font=ALL-UNNAMED" />
					<jvmarg value="-add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED" />
				-->
				<classpath>
					<path refid="testclasspath" />
					<dirset dir="${test_classes}"/>
				</classpath>
				<formatter type="xml" />
				<batchtest todir="${junit-reports}">
					<fileset dir="${test_classes}">
						<include name="**/*Test.class" />
					</fileset>
				</batchtest>
			</junit>
		</jacoco:coverage>
	</target>
	
	<target name="remove-classes" depends="init">
		<!-- delete the compiled classes folder -->
		<delete dir="${classes}" />
		<delete dir="${test_classes}" />
	</target>
</project>
